{
    "contents" : "library(FLBEIA)\nlibrary(FLCore)\nlibrary(ggplot2)\nlibrary(RColorBrewer)\nlibrary(grid)\nlibrary(shape)\n\nit <- 250\n\n# stock recruitment plots\nload(\"c:/use/Google Drive/Myfish/FLBEIA/data/srIter-SANTI.RData\")\nload(\"c:/use/Google Drive/Myfish/FLBEIA/data/Myfish_1Iter.RData\")\n\nsetwd('C:/use/Google Drive/Myfish/Papers/One')\nload('./R/MSY_MSMSY_LO.RData')\n\ngears <- c(DFN_SP = 'Gillnetters (SP)', HOK_SP = 'Hooks and Lines (SP)', DTS_SP = 'Trawlers (SP)',\n           DTS_PT = 'Trawlers (PT)', PGP_PT = 'Polyvalent Gears (PT)')\n\ngears <- c(DFN_SP = 'Gillnetters', HOK_SP = 'Hooks and Lines', DTS_SP = 'Trawlers')\n\nscnms <- scnms[c(1:8)]\n\nBIO         <- subset(BIO, scenario %in% scnms)                            \nBIOSTD      <- subset(BIOSTD, scenario %in% scnms)                            \nCATCHFL     <- subset(CATCHFL, scenario %in% scnms)                          \nCATCHMT     <- subset(CATCHMT, scenario %in% scnms)                                                          \nECO         <- subset(ECO, scenario %in% scnms)  \nbioM        <- subset(bioM, scenario %in% scnms)    \nbioStdM     <- subset(bioStdM, scenario %in% scnms)  \ncatchFlM    <- subset(catchFlM, scenario %in% scnms)   \ncatchMtM    <- subset(catchMtM, scenario %in% scnms)  \necoM        <- subset(ecoM, scenario %in% scnms)  \neffortMtM   <- subset(effortMtM, scenario %in% scnms)  \n\nvplayout <- function(x, y) viewport(layout.pos.row = x, layout.pos.col = y)\n\n# Color \nn <- 4\ngg_color_hue <- function(n) {\n  hues = seq(15, 375, length=n+1)\n  hcl(h=hues, l=65, c=100)[1:n]\n}\ncols4 <- gg_color_hue(4)\n\n#cols4 <- c(brewer.pal(9, 'Reds')[9],\n#                   brewer.pal(9, 'Greens')[7],\n#                   brewer.pal(9, 'Blues')[5],\n#                   brewer.pal(9, 'Purples')[4])\n\n#===============================================================================\n# Change the name of the scenarios \n#===============================================================================\nBIO$scenario <- ifelse(BIO$scenario == scnms[1], 'ices_trad', ifelse(BIO$scenario == scnms[2], 'msmsy_trad',\n                    ifelse(BIO$scenario == scnms[3], 'ices_trad_lo', ifelse(BIO$scenario == scnms[4], 'msmsy_trad_lo',\n                          ifelse(BIO$scenario == scnms[5], 'ices_mpro', ifelse(BIO$scenario == scnms[6], 'msmsy_mpro',\n                                 ifelse(BIO$scenario == scnms[7], 'ices_mpro_lo', 'msmsy_mpro_lo')))))))                                                  \n\nECO$scenario <- ifelse(ECO$scenario == scnms[1], 'ices_trad', ifelse(ECO$scenario == scnms[2], 'msmsy_trad',\n                       ifelse(ECO$scenario == scnms[3], 'ices_trad_lo', ifelse(ECO$scenario == scnms[4], 'msmsy_trad_lo',\n                              ifelse(ECO$scenario == scnms[5], 'ices_mpro', ifelse(ECO$scenario == scnms[6], 'msmsy_mpro',\n                                     ifelse(ECO$scenario == scnms[7], 'ices_mpro_lo', 'msmsy_mpro_lo')))))))                                                  \n\n\nCATCHFL$scenario <- ifelse(CATCHFL$scenario == scnms[1], 'ices_trad', ifelse(CATCHFL$scenario == scnms[2], 'msmsy_trad',\n                       ifelse(CATCHFL$scenario == scnms[3], 'ices_trad_lo', ifelse(CATCHFL$scenario == scnms[4], 'msmsy_trad_lo',\n                              ifelse(CATCHFL$scenario == scnms[5], 'ices_mpro', ifelse(CATCHFL$scenario == scnms[6], 'msmsy_mpro',\n                                     ifelse(CATCHFL$scenario == scnms[7], 'ices_mpro_lo', 'msmsy_mpro_lo')))))))    \n\nEFFORTMT$scenario <- ifelse(EFFORTMT$scenario == scnms[1], 'ices_trad', ifelse(EFFORTMT$scenario == scnms[2], 'msmsy_trad',\n                            ifelse(EFFORTMT$scenario == scnms[3], 'ices_trad_lo', ifelse(EFFORTMT$scenario == scnms[4], 'msmsy_trad_lo',\n                                   ifelse(EFFORTMT$scenario == scnms[5], 'ices_mpro', ifelse(EFFORTMT$scenario == scnms[6], 'msmsy_mpro',\n                                          ifelse(EFFORTMT$scenario == scnms[7], 'ices_mpro_lo', 'msmsy_mpro_lo')))))))    \n\n\nscnms <- unique(BIO$scenario)\n\n\n#===============================================================================\n#  Fishing Mortality\n#===============================================================================\n\nrefpts <- data.frame(stock = rep(colnames(BRPs[1,c(1,3),,1]),2), hcr = rep(c('MSY', 'MSMSY'), each = 5), f = c(BRPs[1,1,,1], BRPs[1,2,,1]))\nrefpts[6:10,3] <-  sapply(advice.ctrl.msmsy, function(x) ifelse(is.null(x$ref.pts[1,]), NA, x$ref.pts[1,]))[c(1:2,4,6:7)]\ncols <- cols4\n\ndat <- subset(BIO,  stock %in%  c('HKE', 'MON', 'MEG', 'LDB', 'HOM') & indicator == 'f' & year == 2025)\n\ndat <- aggregate(list(f = dat$value), list(stock = dat$stock,scenario = dat$scenario), quantile, probs = c(0.05,0.5,0.95))\n\ndat <- cbind(dat[,1:2], dat[,3][,1:3])\nnames(dat)[3:5] <- c('f05', 'f50', 'f95')\n\ndat$landOb <- ifelse(dat$scenario %in% unique(dat$scenario)[c(2,4,6,8)], TRUE, FALSE)\ndat$hcr    <- ifelse(dat$scenario %in% unique(dat$scenario)[1:4], 'ices', 'msmsy')\ndat$fldyn  <- ifelse(dat$scenario %in% unique(dat$scenario)[c(3:4,7:8)], 'MPro', 'Trad')\ndat$flhcr <- paste(dat$fldyn, dat$hcr, sep = \"_\")\n  \ndat$scenario <- factor(dat$scenario, levels = scnms[c(1,2,5,6,3,4,7,8)]) \n\np <- ggplot(data=dat, aes(x=factor(scenario), y=f50)) + \n  geom_errorbar(aes(ymin=f05, ymax=f95),\n                width=.1, lwd = 1,                    # Width of the error bars\n                position=position_dodge(), col = 'black') +\n  geom_hline(data = refpts, aes(yintercept= f , linetype = hcr), lwd = 1.2, lty = 1:2) +\n  geom_point(aes(fill = factor(flhcr), colour = factor(flhcr), shape = factor(landOb)), size = 4) +\n  facet_grid(stock ~., scale=\"free\", space=\"fixed\") +  \n  theme(axis.title.x = element_blank()) +   # Remove x-axis label\n  ylab(\"\") +\n  scale_fill_manual(values= cols) +\n  scale_shape_manual(values= c(21,24)) \n\n\njpeg(\"./Plots/Article/Figure_2_Fishing_Mortality_COLOR.jpg\",\n     width = 400, height = 400*1.618,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 15), \"null\"))))\n\ngrid.text(\"Fishing Mortality\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"none\", legend.key.size = unit(.5, 'line'), text = element_text(size = 15), axis.text.x=element_text(angle=90)), vp = vplayout(2, 1))\n\ndev.off()\n\n\njpeg(\"./Plots/Article/Figure_2_Fishing_Mortality_COLOR_PRES.jpg\",\n     width = 400*1.618, height = 400*1.618,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 15), \"null\"))))\n\ngrid.text(\"Fishing Mortality\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"none\", legend.key.size = unit(.5, 'line'), text = element_text(size = 15), axis.text.x=element_text(angle=90)), vp = vplayout(2, 1))\n\ndev.off()\n\n\n\n#===============================================================================\n#  PROFITS: 2 Plots, F3 and MP\n#===============================================================================\n\ncols <- cols4\n\n\necoQ <- aggregate(list(profits = ECO$profits),\n                   list(year = ECO$year, fleet = ECO$fleet, scenario = ECO$scenario, hcr = ECO$hcr,\n                        fldyn = ECO$fldyn, landOb = ECO$landOb), quantile, probs = c(0.05,0.5,0.95), na.rm = T)\n\nSelSces <- scnms[1:4]\n\nbardat <- subset(ecoQ, year %in% ac(c(2018,2025)) & scenario %in% SelSces)\nbardat$scenario <- factor(bardat$scenario, levels = SelSces)\nd11 <- subset(ecoQ, year == '2011' & scenario == scnms[1])\n\n\nbardat <- cbind(bardat, q05 = bardat[,'profits'][,'5%']/1000000,  q50 = bardat[,'profits'][,'50%']/1000000, \n                  q95 = bardat[,'profits'][,'95%']/1000000)\nbardat <- subset(bardat, fleet %in% names(gears))\n\nbardat$fleet <- ifelse(bardat$fleet == 'DFN_SP', \"Gillnetters (SP)\",\n                       ifelse(bardat$fleet == 'HOK_SP', \"Hooks and Lines (SP)\", \n                              ifelse(bardat$fleet == 'DTS_SP',  'Trawlers (SP)',\n                                     ifelse(bardat$fleet == 'DTS_PT', 'Trawlers (PT)', 'Polyvalent Gears (PT)'))))\n\n p <- ggplot(data=bardat, aes(x=scenario, y=q50, fill=scenario)) + \n    geom_bar(stat=\"identity\", position=position_dodge(width = 0.9)) + \n  #  geom_text( aes(x=scenario,y=1,label= round(numbVessels)), data = labels, parse = TRUE, hjust = 0.5, colour = 'white') +\n    scale_fill_manual(values= cols) +\n    facet_grid(fleet~year, scale=\"free\", space=\"fixed\") +  \n  # geom_hline(aes(yintercept= y0), colour=\"black\", linetype=\"dashed\", size = 0.8) +\n    scale_x_discrete(breaks=NULL) +\n  #  ggtitle( 'Profits \\n Traditional Fleet Dynamics') +\n    theme(axis.title.x = element_blank()) +   # Remove x-axis label\n    ylab(\"Million Euro\") +\n    geom_errorbar(aes(ymin=q05, ymax=q95),\n                 width=.2, lwd = 1.1,                    # Width of the error bars\n                 position=position_dodge(), col = 'white') \n\n print(p)\n\n\n\njpeg(\"./Plots/Article/Figure_3_Profits_Traditional_COLOR.jpg\",\n     width = 400, height = 400*1.618,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 10), \"null\"))))\n\ngrid.text(\"Profits \\n Traditional Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'), \n                panel.grid.major.x = element_blank()) +     \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(2, 1))\ndev.off()\n\n\njpeg(\"./Plots/Article/Figure_3_Profits_Traditional_COLOR_PRES.jpg\",\n     width = 400*1.618, height = 600,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 10), \"null\"))))\n\ngrid.text(\"Profits \\n Traditional Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),\n                panel.grid.major.x = element_blank()) +     \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(2, 1))\ndev.off()\n\n\nSelSces <- scnms[5:8]\n\nbardat <- subset(ecoQ, year %in% ac(c(2018,2025)) & scenario %in% SelSces)\nbardat$scenario <- factor(bardat$scenario, levels = SelSces)\nd11 <- subset(ecoQ, year == '2011' & scenario == 'MSY_F3')\n\n\nbardat <- cbind(bardat, q05 = bardat[,'profits'][,'5%']/1000000,  q50 = bardat[,'profits'][,'50%']/1000000, \n                q95 = bardat[,'profits'][,'95%']/1000000)\n\nbardat <- cbind(bardat, q05 = bardat[,'profits'][,'5%']/1000000,  q50 = bardat[,'profits'][,'50%']/1000000, \n                q95 = bardat[,'profits'][,'95%']/1000000)\nbardat <- subset(bardat, fleet %in% names(gears))\n\nbardat$fleet <- ifelse(bardat$fleet == 'DFN_SP', \"Gillnetters (SP)\",\n                       ifelse(bardat$fleet == 'HOK_SP', \"Hooks and Lines (SP)\", \n                              ifelse(bardat$fleet == 'DTS_SP',  'Trawlers (SP)',\n                                     ifelse(bardat$fleet == 'DTS_PT', 'Trawlers (PT)', 'Polyvalent Gears (PT)'))))\n\n\n\np <- ggplot(data=bardat, aes(x=scenario, y=q50, fill=scenario)) + \n  geom_bar(stat=\"identity\", position=position_dodge(width = 0.9)) + \n  #  geom_text( aes(x=scenario,y=1,label= round(numbVessels)), data = labels, parse = TRUE, hjust = 0.5, colour = 'white') +\n  scale_fill_manual(values= cols) +\n  facet_grid(fleet~year, scale=\"free\", space=\"fixed\") +  \n  # geom_hline(aes(yintercept= y0), colour=\"black\", linetype=\"dashed\", size = 0.8) +\n  scale_x_discrete(breaks=NULL) +\n   #  ggtitle( \"Profits \\n Profit Maximization Fleet Dynamics\") +\n  theme(axis.title.x = element_blank()) +   # Remove x-axis label\n  ylab(\"Million Euro\") +\n  geom_errorbar(aes(ymin=q05, ymax=q95),\n                width=.2, lwd = 1.1,                    # Width of the error bars\n                position=position_dodge(), col = 'white') \n\nprint(p)\n\n\n\njpeg(\"./Plots/Article/Figure_4_Profits_MaxProfits_COLOR_PRES.jpg\",\n     width = 400*1.618, height = 600,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 10), \"null\"))))\n\ngrid.text(\"Profits \\n Profit Maximization Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"bottom\", legend.key.size = unit(.5, 'line'),text = element_text(size = 14.5),\n                panel.grid.major.x = element_blank()) +     \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(2, 1))\ndev.off()\n\n\njpeg(\"./Plots/Article/Figure_3_Profits_Traditional_COLOR_PRES.jpg\",\n     width = 400*1.618, height = 600,  pointsize = 20, \n     quality = 100)\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(2, 1, heights = unit(c(1, 10), \"null\"))))\n\ngrid.text(\"Profits \\n Traditional Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n\nprint(p + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),\n                panel.grid.major.x = element_blank()) +     \n          guides(fill=guide_legend(title=NULL)), vp = vplayout(2, 1))\ndev.off()\n\n\n\n\nxx <- subset(ecoQ, year  %in% c(2018, 2025) & fleet %in% names(gears))\n\nwrite.csv(xx, file = './Tables/EcoSummary.csv')\n\n#===============================================================================\n#  NET PRESENT VALUE\n#===============================================================================\nnpv.df <- numeric(length(npv))\nnames(npv.df) <- names(npv)\nfor(i in 1:length(npv)) npv.df[i] <- round(sum(npv[[i]][c(1,3,4),2])/1e6)\n\nwrite.csv(npv.df,'./Tables/npv.csv')  \n\n\n#===============================================================================\n#  Quota share utilization 2025\n#===============================================================================\n\ndat <- subset(CATCHFL, scenario %in% scnms & year == '2025' & fleet %in% names(gears))\ndat <- cbind(dat, ratio = ((dat$landings+dat$discards)/dat$tacshare) -1) \n\nfor(fl in unique(dat$fleet)){\n  d11 <- subset(CATCHFL, CATCHFL$year == 2011 & CATCHFL$fleet == fl & CATCHFL$stock == 'OTH')[1,]\n  dat[dat$fleet == fl & dat$stock == 'OTH', 'ratio'] <- ((dat[dat$fleet == fl & dat$stock == 'OTH', 'landings'] + \n                                                         dat[dat$fleet == fl & dat$stock == 'OTH', 'discards'])/\n                                                          d11$landings) -1\n  \n}\n\ndat$stock[dat$stock == 'HKE'] <- 'Hake'\ndat$stock[dat$stock == 'MEG'] <- 'Megrim'\ndat$stock[dat$stock == 'MON'] <- 'Monkfish'\ndat$stock[dat$stock == 'LDB'] <- '4S Megrim'\ndat$stock[dat$stock == 'MAC'] <- 'Mackerel'\ndat$stock[dat$stock == 'HOM'] <- 'H. Mack. (S)'\ndat$stock[dat$stock == 'HO8'] <- 'H. Mack. (W)'\ndat$stock[dat$stock == 'WHB'] <- 'B. Whiting'\ndat$stock[dat$stock == 'OTH'] <- 'Other'\n\ndatQ <- aggregate(list(ratio = dat$ratio), list(fleet = dat$fleet, scenario = dat$scenario, stock = dat$stock), \n                  quantile, probs = c(0.05,0.5,0.95))\n\ndatQ <- cbind(datQ[,1:3], datQ[,4][,1:3])\nnames(datQ)[4:6] <- c('q05', 'q50', 'q95')\n\ndatQ$scenario <- factor(datQ$scenario, levels =scnms)\npl.f3 <- vector('list',5)\nnames(pl.f3) <- names(gears)\n\npl.mp <- pl.f3\n\nfor(fl in names(gears)){\n  \n  bardat_fl <- subset(datQ, fleet == fl & scenario %in% scnms[1:4])\n  \n  pl.f3[[fl]] <- ggplot(data=bardat_fl, aes(x=scenario, y = q50, fill=scenario)) + \n    geom_bar(stat=\"identity\", position=position_dodge(width = 0.9)) + \n    scale_fill_manual(values= cols) +\n    facet_grid(.~stock, scale=\"free_x\", space=\"free\") +  \n      scale_x_discrete(breaks=NULL) +\n    ggtitle( gears[fl]) +\n #   geom_errorbar(aes(ymin=q05, ymax=q95),\n #                  width=.2, lwd = 1.1,                    # Width of the error bars\n#                  position=position_dodge(), col = 'white') +\n  geom_hline(aes(yintercept = 0)) +\n    theme(axis.title.x = element_blank()) +   # Remove x-axis label\n    ylab(\"%\") \n  \n  bardat_fl <- subset(datQ, fleet == fl & scenario %in% scnms[5:8])\n  \n  pl.mp[[fl]] <- ggplot(data=bardat_fl, aes(x=scenario, y = q50, fill=scenario)) + \n    geom_bar(stat=\"identity\", position=position_dodge(width = 0.9)) + \n    scale_fill_manual(values= cols) +\n    facet_grid(.~stock, scale=\"free_x\", space=\"free\") +  \n    scale_x_discrete(breaks=NULL) +\n    ggtitle( gears[fl]) +\n    theme(axis.title.x = element_blank()) +   # Remove x-axis label\n  geom_hline(aes(yintercept = 0))\n #   geom_errorbar(aes(ymin=q05, ymax=q95),\n #                  width=.2, lwd = 1.1,                    # Width of the error bars\n#                  position=position_dodge(), col = 'white') +\n    ylab(\"%\") \n  \n}\n\n\n\n\njpeg(\"./Plots/Article/Figure_5_QuotaUptake_Traditional_COLOR_Symp.jpg\",\n     width = 530*1.618, height = 530,  pointsize = 20, \n     quality = 100)\n\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(3, 2, heights = unit(c(1, 4, 5), \"null\"))))\ngrid.text(\"Traditional Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1:2))\n\nprint(pl.f3[['DFN_SP']] + ggtitle(gears[1]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(2, 1))\nprint(pl.f3[['HOK_SP']] + ggtitle(gears[2]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(2, 2))\nprint(pl.f3[['DTS_SP']] + ggtitle(gears[3]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),plot.margin = unit(c(0,.51,0,0), \"lines\")) +      \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(3, 1:2)) \n\ndev.off()\n\n\njpeg(\"./Plots/Article/Figure_6_QuotaUptake_MaxProfit_COLOR_Symp.jpg\",\n     width = 530*1.618, height = 530,  pointsize = 20, \n     quality = 100)\n\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(3, 2, heights = unit(c(1, 4, 4), \"null\"))))\ngrid.text(\"Quota Uptake \\n Profit Maximization Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1:2))\n\nprint(pl.mp[['DFN_SP']] + ggtitle(gears[1]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 15), plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(2, 1))\nprint(pl.mp[['HOK_SP']] + ggtitle(gears[2]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 15), plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(2, 2))\nprint(pl.mp[['DTS_SP']] + ggtitle(gears[3]) + xlab(\"\") + ylab(\"prop.\") + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.5, 'line'),plot.margin = unit(c(0,.51,0,0), \"lines\")) +      \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(3, 1:2)) \ndev.off()\n\n\n\n\n\n#===============================================================================\n#  Effort by metier\n#===============================================================================\neffortMtQ <- aggregate(list(effshare = EFFORTMT$effshare), list(year = EFFORTMT$year, \n                  fleet = EFFORTMT$fleet, metier = EFFORTMT$metier, scenario  = EFFORTMT$scenario), quantile, probs = c(0.05,0.5,0.95))\n\ndat <- subset(effortMtQ, fleet %in% names(gears) & year > 2012)\ndat <- cbind(dat, hcr = ifelse(dat$scenario %in% scnms[c(1,3,5,7)], 'ices', 'msmsy'), \n             fldyn = ifelse(dat$scenario %in% scnms[1:4], 'F3', 'MP'),\n             landOb = ifelse(dat$scenario %in% scnms[c(3,4,7,8)], TRUE, FALSE))\ndat <- cbind(dat[,1:4], dat[,5], dat[,6:8])\nnames(dat)[5:7] <- c('q05', 'q50', 'q95')\n\nefs_sq <- subset(dat, year == '2013' & scenario == scnms[1])\nefs_sq$metier <- substr(efs_sq$metier,1,7)\ndat <- subset(dat, dat$fldyn == 'MP' & year == '2025')\n\n# metiers to keep.\nmet <- vector('list', 3)\nnames(met) <- names(gears)[1:3]\nmet[['DFN_SP']] <- c('GTR_DEF', 'LLS_DEF', 'LHM_SPF')\nmet[['HOK_SP']] <- c('GTR_DEF', 'LLS_DEF', 'LHM_SPF')\nmet[['DTS_SP']] <- c('OTB_DEF', 'PTB_MPD', 'OTB_MPD')\n\ncols <- cols4\n\npl.bp <- vector('list',3)\nnames(pl.bp) <- names(gears)[1:3]\n  \nfor(fl in names(gears)[1:3]){\n\n  dat$metier <- substr(dat$metier,1,7)\n  bardat_fl <- subset(dat, year == '2025' & fleet == fl & scenario %in% scnms[5:8] & (metier %in% met[[fl]] ))\n  bardat_fl$scenario <- factor(bardat_fl$scenario, levels = scnms[5:8])\n  efs_sq_fl <- subset(efs_sq, fleet == fl & (metier %in% met[[fl]] ))\n  \n\n  \n  pl.bp[[fl]] <- ggplot(data=bardat_fl, aes(x=scenario, y = q50, fill=scenario)) + \n    geom_bar(stat=\"identity\", position=position_dodge(width = 0.9)) + \n    scale_fill_manual(values= cols) +\n    facet_grid(.~metier, scale=\"free_x\", space=\"free\") +  \n    geom_hline(data = efs_sq_fl,aes(yintercept= q50), colour=\"black\", linetype=\"dashed\", size = 0.8) +\n    scale_x_discrete(breaks=NULL) +\n    ggtitle( gears[fl]) +\n    theme(axis.title.x = element_blank()) +   # Remove x-axis label\n    geom_errorbar(aes(ymin=q05, ymax=q95),\n                  width=.2, lwd = 1.1,                    # Width of the error bars\n                  position=position_dodge(), col = 'white') \n    ylab(\"%\") \n}  \n\n\n\njpeg(\"./Plots/Article/Figure_7_EffortShare_COLOR_symp.jpg\",\n     width = 400, height = 400*1.618,  pointsize = 20, \n     quality = 100)\n\ngrid.newpage()\npushViewport(viewport(layout = grid.layout(4, 1, heights = unit(c(2, 5, 5,6), \"null\"))))\n             \ngrid.text(\"Effort Share \\n Profit Maximization Fleet Dynamics\", gp = gpar(fontsize = 18), vp = viewport(layout.pos.row = 1, layout.pos.col = 1))\n             \nprint(pl.bp[['DFN_SP']] + ggtitle(gears[1]) + xlab(NULL) + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 15), plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(2, 1))\nprint(pl.bp[['HOK_SP']] + ggtitle(gears[2]) + xlab(NULL) + ylab(\"prop.\") + theme(legend.position=\"none\", text = element_text(size = 15), plot.margin = unit(c(0,.51,0,0), \"lines\")), vp = vplayout(3, 1))\nprint(pl.bp[['DTS_SP']] + ggtitle(gears[3]) + xlab(NULL) + ylab(\"prop.\") + theme(legend.position=\"bottom\", text = element_text(size = 14.5), legend.key.size = unit(.2, 'line'),plot.margin = unit(c(0,.51,0,0), \"lines\")) +      \n        guides(fill=guide_legend(title=NULL)), vp = vplayout(4, 1)) \ndev.off()\n\n\n\n\n#===============================================================================\n# TABLE WITH REFERENCE POINTS.\n#===============================================================================\n\nload(\"~/Google Drive/Myfish/FLBEIA/Data/GridDataSets/Myfish_2.RData\")\n\nhkerp <- lapply(advice.ctrl.ices, function(x) x$ref.pts)$HKE\nmonrp <- lapply(advice.ctrl.ices, function(x) x$ref.pts)$MON\nhomrp <- lapply(advice.ctrl.ices, function(x) x$ref.pts)$HOM\nldbrp <- lapply(advice.ctrl.ices, function(x) x$ref.pts)$LDB\nmegrp <- lapply(advice.ctrl.ices, function(x) x$ref.pts)$MEG\n\n\nhkemsrp <- lapply(advice.ctrl.msmsy, function(x) x$ref.pts)$HKE[1,]\nmonmsrp <- lapply(advice.ctrl.msmsy, function(x) x$ref.pts)$MON[1,]\nhommsrp <- lapply(advice.ctrl.msmsy, function(x) x$ref.pts)$HOM[1,]\nldbmsrp <- lapply(advice.ctrl.msmsy, function(x) x$ref.pts)$LDB[1,]\nmegmsrp <- lapply(advice.ctrl.msmsy, function(x) x$ref.pts)$MEG[1,]\n\nrps <- cbind(hkerp, homrp, megrp,ldbrp,monrp)\n\nrps <- rbind(rps[1,], cbind(hkemsrp, hommsrp, megmsrp,ldbmsrp,monmsrp), rps[2:3,])\n\ncolnames(rps) <- c('HKE', 'HOM', 'MEG', 'LDB', 'MON')\n\nwrite.csv(rps,\"C:/use/Google Drive/Myfish/Papers/One/Tables/Table_1_ReferencePoints.csv\")\nround(sapply(biols, function(x) ssb(x)[,'2012'])[c(1:2,4,6:7)])\n\n\n#===============================================================================\n#  COMPARISON OF SELECTION PATTERNS, \n#   *  GLOBAL IN 2012 with:\n# We don't have the data needed to calculate the vectors below.\n#   *  YEARLY GLOBAL SELECTION PATTERS MaxProfit \n#   *  SELECTION PATTERNS AT FLEET LEVEL. \n#===============================================================================\n# We don't whave age structured data in the proyection, so we calculate selection \n# patterns using ...@catch.q and, effort share along metiers and total effort as a \n# weighting factor.\n\n# *  GLOBAL SelPat 2012 and at fleet level\n#---------------------------\nSelPat    <- vector('list',5)\nnames(SelPat) <- names(biols)[c(1,2,4,6,7)]\nSelPat_yr <- vector('list',5)\nSelPat_fl <- SelPat_fl_yr <- SelPat\n\nfor(st in names(biols)[c(1,2,4,6,7)]){\n  SelPat_yr[[st]] <- biols[[st]]@n[,ac(2010:2012)]\n  SelPat_yr[[st]][] <- 0\n  \n  for(yr in ac(2010:2012)){\n    for(fl in names(fleets)){\n      for(mt in names(fleets[[fl]]@metiers)){\n      \n        if(!(st %in% catchNames(fleets[[fl]]@metiers[[mt]]))) next\n      \n        SelPat_yr[[st]][,yr] <- SelPat_yr[[st]][,yr] +  c(fleets[[fl]][[mt]][[st]]@catch.q[,yr])*c(fleets[[fl]][[mt]]@effshare[,yr]*fleets[[fl]]@effort[,yr])\n      }\n    }\n  }\n  SelPat[[st]] <- yearMeans(SelPat_yr[[st]])\n}\n\n\n# *  SelPat 2012 and at fleet level\n#---------------------------\nSelPat_fl    <- vector('list',5)\nnames(SelPat_fl) <- names(biols)[c(1,2,4,6,7)]\nSelPat_fl_yr <- vector('list',5)\n\n\nfor(st in names(biols)[c(1,2,4,6,7)]){\n  na   <- dim(biols[[st]]@n)[1] \n  nanm <- dimnames(biols[[st]]@n)[[1]] \n  SelPat_fl_yr[[st]] <- array(0, dim = c(na,3,3), dimnames = list(nanm, c('DTS_SP', 'DFN_SP', 'HOK_SP'), 2010:2012))\n  \n \n  \n  for(yr in ac(2010:2012)){\n    for(fl in  c('DTS_SP', 'DFN_SP', 'HOK_SP')){\n      for(mt in names(fleets[[fl]]@metiers)){\n        \n        if(!(st %in% catchNames(fleets[[fl]]@metiers[[mt]]))) next\n        \n        SelPat_fl_yr[[st]][,fl,yr] <- SelPat_fl_yr[[st]][,fl,yr] +  c(fleets[[fl]][[mt]][[st]]@catch.q[,yr])*c(fleets[[fl]][[mt]]@effshare[,yr]*fleets[[fl]]@effort[,yr])\n      }\n    }\n  }\n  SelPat_fl[[st]] <- apply(SelPat_fl_yr[[st]],1:2, mean)\n}\n\n\n#   *  YEARLY GLOBAL SELECTION PATTERN MaxProfit, 4 MaxProfit scenarios\n#------------------------------------------------------------------------\nSelPat_MP_yr    <- vector('list',5)\nnames(SelPat_MP_yr) <- names(biols)[c(1,2,4,6,7)]\n\nfor(st in names(biols)[c(1,2,4,6,7)]){\n  \n  na   <- dim(biols[[st]]@n)[1] \n  nanm <- dimnames(biols[[st]]@n)[[1]] \n  SelPat_MP_yr[[st]] <- array(0, dim = c(na,2,4), dimnames = list(nanm, c(2018,2025), scnms[5:8]))\n  \n  for(sc in scnms[5:8]){\n    for(yr in ac(c(2018,2025))){\n      for(fl in names(fleets)){\n        for(mt in names(fleets[[fl]]@metiers)){\n        \n          if(!(st %in% catchNames(fleets[[fl]]@metiers[[mt]]))) next\n        \n          SelPat_MP_yr[[st]][,yr,sc] <- SelPat_MP_yr[[st]][,yr,sc] +  \n                                      c(fleets[[fl]][[mt]][[st]]@catch.q[,ac('2018')])*\n                                      median(subset(EFFORTMT,fleet == fl & metier == mt & year == yr & scenario == sc)$effshare)*\n                                      median(subset(ECO,fleet == fl  & year == yr & scenario == sc)[,'effort'])\n                                      \n        }\n      }\n    }\n  \n  }\n}\n\n\n#   *  YEARLY  SELECTION PATTERN FLEET LEVEL MaxProfit, 4 MaxProfit scenarios\n#-----------------------------------------------------------------------------\nSelPat_MP_yr_fl    <- vector('list',5)\nnames(SelPat_MP_yr_fl) <- names(biols)[c(1,2,4,6,7)]\n\nfor(st in names(biols)[c(1,2,4,6,7)]){\n  \n  na   <- dim(biols[[st]]@n)[1] \n  nanm <- dimnames(biols[[st]]@n)[[1]] \n  SelPat_MP_yr_fl[[st]] <- array(0, dim = c(na,2,3,4), dimnames = list(nanm, c(2018,2025), c('DTS_SP', 'HOK_SP', 'DFN_SP'), scnms[5:8]))\n  \n  for(sc in scnms[5:8]){\n    for(yr in ac(c(2018,2025))){\n      for(fl in c('DTS_SP', 'HOK_SP', 'DFN_SP')){\n        for(mt in names(fleets[[fl]]@metiers)){\n          \n          if(!(st %in% catchNames(fleets[[fl]]@metiers[[mt]]))) next\n          \n          SelPat_MP_yr_fl[[st]][,yr,fl,sc] <- SelPat_MP_yr_fl[[st]][,yr,fl,sc] +  \n            c(fleets[[fl]][[mt]][[st]]@catch.q[,ac('2018')])*\n            median(subset(EFFORTMT,fleet == fl & metier == mt & year == yr & scenario == sc)$effshare)*\n            median(subset(ECO,fleet == fl  & year == yr & scenario == sc)[,'effort'])\n          \n        }\n      }\n    }\n    \n  }\n}\n\n\n# PLOT THE SELECTION PATTERNS.\n#------------------------------------------------------------------------\n\npdf(\"./Plots/SelPat.pdf\", width = 10/2.54, height = 15/2.54)\nfor(yr in ac(c(2018,2025))){ \n  for(sc in scnms[5:8]){ \n    par(mfrow = c(3,2), oma = c(1,1,1.4,1))\n   \n    for(st in names(biols)[c(1,2,4,6,7)]){\n      nanm <- dimnames(biols[[st]]@n)[[1]]\n      plot(nanm, c(SelPat[[st]]/max(SelPat[[st]])), main = st, ylab = \"\",xlab = \"\", lwd = 3, type = \"l\", ylim = c(0,1))\n      \n      k <- 2\n      for(fl in c('DTS_SP', 'HOK_SP', 'DFN_SP')){ \n        lines(nanm, SelPat_MP_yr_fl[[st]][,yr,fl,sc]/max(SelPat_MP_yr_fl[[st]][,yr,fl,sc]), col = k, lty = 2)\n        lines(nanm, SelPat_fl[[st]][,fl]/max(SelPat_fl[[st]][,fl]), col = k)\n        k <- k+1\n      }\n      lines(nanm, SelPat_MP_yr[[st]][,yr,sc]/max(SelPat_MP_yr[[st]][,yr,sc]), col = 1, lty = 2)\n    }\n    mtext(paste(sc, yr, sep = \" - \"), outer = TRUE, at = 0.5, font = 2)\n    \n  }\n}\ndev.off()\n\n\n# Distancia euclidea entre los patrones.\ndistSelPat_fl <- matrix(0,3,5, dimnames = list(c('DTS_SP', 'HOK_SP', 'DFN_SP'), names(biols)[c(1,2,4,6,7)]))\ndistSelPat_MP_fl <- array(0, c(3,5,4,2), dimnames = list(c('DTS_SP', 'HOK_SP', 'DFN_SP'), names(biols)[c(1,2,4,6,7)],scnms[5:8], c(2018,2025)))\ndistSelPat_MP <- array(0, c(5,4,2), dimnames = list(names(biols)[c(1,2,4,6,7)],scnms[5:8], c(2018,2025)))\n\nfor(fl in c('DTS_SP', 'HOK_SP', 'DFN_SP')){\n  for(st in names(biols)[c(1,2,4,6,7)]){\n  distSelPat_fl[fl,st] <- sqrt(sum((SelPat[[st]]/max(SelPat[[st]]) - \n                                  SelPat_fl[[st]][,fl]/max(SelPat_fl[[st]][,fl]))^2))\n    \n  }\n}\n\nfor(fl in c('DTS_SP', 'HOK_SP', 'DFN_SP')){\n  for(st in names(biols)[c(1,2,4,6,7)]){\n    for(sc in scnms[5:8]){\n      for(yr in  ac(c(2018,2025))){\n        distSelPat_MP_fl[fl,st,sc,yr] <- sqrt(sum((SelPat[[st]]/max(SelPat[[st]]) - \n                                            SelPat_MP_yr_fl[[st]][,yr,fl,sc]/max(SelPat_MP_yr_fl[[st]][,yr,fl,sc]))^2))\n    \n      }\n    }\n  }\n}\n\n\n\nfor(st in names(biols)[c(1,2,4,6,7)]){\n  for(sc in scnms[5:8]){\n    for(yr in  ac(c(2018,2025))){\n      distSelPat_MP[st,sc,yr] <- sqrt(sum((SelPat[[st]]/max(SelPat[[st]]) - \n                                                   SelPat_MP_yr[[st]][,yr,sc]/max(SelPat_MP_yr[[st]][,yr,sc]))^2))\n        \n    }\n  }\n}\n\n\n# \"distSelPat_fl\"    \"distSelPat_MP\"    \"distSelPat_MP_fl\"\n\nmatplot(t(distSelPat_fl), pch = 15, axes = F, ylab = NA, col = 2:4,cex = 1.5)\naxis(1, at = 1:5, names(biols)[c(1,2,4,6,7)])\naxis(2)\n\n\nmatplot(t(distSelPat_MP_fl[,,1,2]), pch = 15, axes = F, ylab = NA, col = 2:4,cex = 1.5)\naxis(1, at = 1:5, names(biols)[c(1,2,4,6,7)])\naxis(2)\n\n\n\n\n",
    "created" : 1445510274093.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3519088397",
    "id" : "5F262751",
    "lastKnownWriteTime" : 1445513314,
    "path" : "~/Google Drive/Myfish/Papers/One/R/04b_Myfish_Graphs_Paper One_COLOR.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}