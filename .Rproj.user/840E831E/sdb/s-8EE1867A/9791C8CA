{
    "contents" : "##==============================================================================\n#               \n#           SIMULATIONS TO GIVE SUPPORT TO SECRETARIA IN THE TAC NEGOTIATION \n#                   FOR 2016 in Iberian Waters Stocks/FLEETS\n#\n# o TRADITIONAL FLEET DYNAMCICS\n#\n# o 2 Scenarios:\n#     * Base Case:\n#       - 2013-2016: HISTORICAL TAC (trad.hist)\n#       - 2016-2025: Ices HCR + LO from 2018.\n#     * Alternative case:\n#       !! note that in this case we start the proyection one year before because in 2016 \n#          we start the F advice instead of 2017.\n#       - 2013-2015: HISTORICAL TAC (trad.hist)\n#       - 2016-2025: F2Catch HCR + LO from 2018.\n#          ~ Starting from Fsq in 2015, Fadv is decreased in the same amount every year \n#          in order to reach Fmsy in 2020.\n#          ~ For HOM (South) as Fsq<Fmsy we use Ices HCR.  \n#\n# Dorleta Garcia \n#         \n# 2015/10/20\n#==============================================================================\n\n\nrm(list=ls())\n\n#==============================================================================\n# Section 1:            Load libraries\n#==============================================================================\n\nlibrary(FLCore) \nlibrary(FLAssess)\nlibrary(FLash)\nlibrary(nloptr)\nlibrary(FLFleet)\nlibrary(FLBEIA) \n\n\n\n#==============================================================================\n# Section 2:            Set directory, Load Objects.\n#==============================================================================\n\niter <- as.numeric(Sys.getenv(\"SGE_TASK_ID\"))\n\n#iter <- 1\n#setwd('c:/use/google drive/MyFish/FLBEIA/')\n\n load(file.path(\"input\", paste(\"Myfish_\",iter,\".RData\", sep = \"\")))\n\n# load(file.path(\"data/gridDataSets\", paste(\"MyFish_\",iter,\".RData\", sep = \"\")))\n\nscriptnm <- 'SG'\n\nmain.ctrl[[1]][2] <- '2025'\n\noutputPath = file.path(\"output\", paste(\"res\",scriptnm,\"_\",iter,\".RData\", sep = \"\"))\n\n\n##==============================================================================\n##  Section 3:      Change some settings\n##==============================================================================\n# change effort restrictor.\nfor(fl in c(\"DFN_SP\", \"HOK_SP\", \"PGP_PT\", \"DTS_PT\", \"DTS_SP\")){\n  fleets.ctrl.trad[[fl]][['effort.restr']][] <- 'prev'\n  fleets.ctrl.trad[[fl]][['effort.restr']][] <- 'prev'\n  fleets.ctrl.trad_lo[[fl]][['effort.restr']][ac(1980:2017)] <- 'prev'\n  fleets.ctrl.trad_lo[[fl]][['effort.restr']][ac(1980:2017)] <- 'prev'\n}\n\n# To avoid selecting an effort corresponding to OTHER stock increase its TAC\nadvice$TAC['OTH',] <- 1e12\n\n# TAC 2016 advice for Base Case.\n# AS there is no LO ion 2016, the TACs are given in landings.\nadvice.BC <- advice\nadvice.BC$TAC['HKE','2016'] <- 5292 \nadvice.BC$TAC['MON','2016'] <- 1343 \nadvice.BC$TAC['MEG','2016'] <- 172\nadvice.BC$TAC['LDB','2016'] <- 841\nadvice.BC$TAC['HOM','2016'] <- 68583\n  \n  \n# advice.ctrl in alternative case, F from 2016 to \nFadv.hke <- c(rep(NA,36), seq(0.73,0.24,  length = 6)[-1], rep(0.24,5)); names(Fadv.hke) <- 1980:2025\nFadv.mon <- c(rep(NA,36), seq(0.21,0.19,  length = 6)[-1], rep(0.19,5)); names(Fadv.mon) <- 1980:2025  \nFadv.meg <- c(rep(NA,36), seq(0.269,0.17, length = 6)[-1], rep(0.17,5)); names(Fadv.meg) <- 1980:2025\nFadv.ldb <- c(rep(NA,36), seq(0.303,0.17, length = 6)[-1], rep(0.17,5)); names(Fadv.ldb) <- 1980:2025\n\nBlims     <-  sapply(biols, function(x) min(ssb(x)[ssb(x)!=0], na.rm=T))\nBtriggers <-  Blims*1.4\n\n\nstks <- names(biols)\nfirst.yr  <- 1980; last.yr <- 2025; ni <- 1  \nadvice.ctrl.AC  <- create.advice.ctrl(stksnames = stks,\n                          HCR.models = c('F2CatchHCR', 'IcesHCR', 'fixedAdvice', 'F2CatchHCR',  'fixedAdvice', 'F2CatchHCR', 'F2CatchHCR', 'fixedAdvice', 'fixedAdvice') ,\n                          ref.pts.HKE = array(Fadv.hke, dim = c(1,length(first.yr:last.yr),ni), dimnames = list(c('Ftarget'),first.yr:last.yr, 1:ni)), \n                          ref.pts.HOM = matrix(c(0.11, Blims['HOM'], Btriggers['HOM']), 3,ni, dimnames = list(c('Fmsy', 'Blim', 'Btrigger'), 1:ni)),\n                          ref.pts.MEG = array(Fadv.meg, dim = c(1,length(first.yr:last.yr),ni), dimnames = list(c('Ftarget'), first.yr:last.yr, 1:ni)),\n                          ref.pts.LDB = array(Fadv.ldb, dim = c(1,length(first.yr:last.yr),ni), dimnames = list(c('Ftarget'), first.yr:last.yr, 1:ni)), immediate = F,\n                          ref.pts.MON = array(Fadv.mon, dim = c(1,length(first.yr:last.yr),ni), dimnames = list(c('Ftarget'), first.yr:last.yr, 1:ni))) # Default values ok for this control\n\nadvice.ctrl.AC$HOM$AdvCatch <- advice.ctrl.ices_lo$HOM$AdvCatch\nadvice.ctrl.AC$HKE$AdvCatch <- advice.ctrl.ices_lo$HKE$AdvCatch\nadvice.ctrl.AC$MON$AdvCatch <- advice.ctrl.ices_lo$MON$AdvCatch\nadvice.ctrl.AC$LDB$AdvCatch <- advice.ctrl.ices_lo$LDB$AdvCatch\nadvice.ctrl.AC$MEG$AdvCatch <- advice.ctrl.ices_lo$MEG$AdvCatch\n\n\n##==============================================================================\n##  Section 4:       Run FLBEIA\n##==============================================================================\n\n\n## BASE CASE\n#---------------\n\n  # 0. histTAC_trad\n  main.ctrl_hist_BC <- main.ctrl\n  main.ctrl_hist_BC[[1]][2] <- 2016\n  hist_BC <- FLBEIA(biols = biols, SRs = SRs, BDs = NULL, fleets=fleets, covars = covars,\n                       indices = NULL, advice = advice.BC, main.ctrl = main.ctrl_hist_BC,\n                       biols.ctrl = biols.ctrl, fleets.ctrl = fleets.ctrl.trad,\n                       covars.ctrl = covars.ctrl, obs.ctrl = obs.ctrl,\n                       assess.ctrl = assess.ctrl, advice.ctrl = advice.ctrl.fixed)\n\n  # 1. ices\n  biols_BC  <- hist_BC$biols\n  fleets_BC <- hist_BC$fleets\n  covars_BC <- hist_BC$covars\n  advice_BC <- hist_BC$advice \n  SRs_BC    <- SRs\n  for(st in names(SRs_BC)) SRs_BC[[st]]@ssb[,ac(2013:2017)] <- ssb(biols_BC[[st]])[,ac(2013:2017)]\n\n  main.ctrl_BC         <- main.ctrl\n  main.ctrl_BC[[1]][1] <- '2016'\n\n  ices  <- FLBEIA(biols = biols_BC, SRs = SRs_BC, BDs = NULL, fleets=fleets_BC, covars = covars_BC,\n                     indices = NULL, advice = advice_BC, main.ctrl = main.ctrl_BC,\n                     biols.ctrl = biols.ctrl, fleets.ctrl = fleets.ctrl.trad_lo,\n                     covars.ctrl = covars.ctrl, obs.ctrl = obs.ctrl,\n                     assess.ctrl = assess.ctrl, advice.ctrl = advice.ctrl.ices_lo)\n\n\n## ALTERNATIVE CASE\n#---------------\n\n# 0. histTAC_trad\nmain.ctrl_hist_AC <- main.ctrl\nmain.ctrl_hist_AC[[1]][2] <- 2015\nhist_AC <- FLBEIA(biols = biols, SRs = SRs, BDs = NULL, fleets=fleets, covars = covars,\n                  indices = NULL, advice = advice, main.ctrl = main.ctrl_hist_AC,\n                  biols.ctrl = biols.ctrl, fleets.ctrl = fleets.ctrl.trad,\n                  covars.ctrl = covars.ctrl, obs.ctrl = obs.ctrl,\n                  assess.ctrl = assess.ctrl, advice.ctrl = advice.ctrl.fixed)\n\n# 1. path\nbiols_AC  <- hist_AC$biols\nfleets_AC <- hist_AC$fleets\ncovars_AC <- hist_AC$covars\nadvice_AC <- hist_AC$advice \nSRs_AC    <- SRs\nfor(st in names(SRs_AC)) SRs_AC[[st]]@ssb[,ac(2013:2016)] <- ssb(biols_AC[[st]])[,ac(2013:2016)]\n\nmain.ctrl_AC         <- main.ctrl\nmain.ctrl_AC[[1]][1] <- '2015'\n\npath  <- FLBEIA(biols = biols_AC, SRs = SRs_AC, BDs = NULL, fleets=fleets_AC, covars = covars_AC,\n                indices = NULL, advice = advice_AC, main.ctrl = main.ctrl_AC,\n                biols.ctrl = biols.ctrl, fleets.ctrl = fleets.ctrl.trad_lo,\n                covars.ctrl = covars.ctrl, obs.ctrl = obs.ctrl,\n                assess.ctrl = assess.ctrl, advice.ctrl = advice.ctrl.AC)\n\n#==============================================================================\n#  Section 4:       Summaries\n#==============================================================================\nscnms <-  c('ices', 'path')\n\n\nscnms_long <- scnms\nnames(scnms_long) <- scnms\n\nlast.yr <- main.ctrl[[1]][2]\n\nbio <- eco <- catchFl <- catchMt <- effortMt <-  bioStd <- bioyr <- NULL\nfor(sc in scnms){\n  print(sc)\n  \n  bio      <- rbind(bio, cbind(bioSum(get(sc), years = ac(2010:last.yr)), scenario = sc))\n  if(sc != 'fixed') covars <- get(sc)$covars\n  eco      <- rbind(eco, cbind(ecoSum(get(sc)$fleets, 'all', ac(2010:last.yr), covars), scenario = sc))\n  catchFl  <- rbind(catchFl, cbind(catchFlSum(get(sc)$fleets, get(sc)$advice, 'all', 'all', ac(2010:last.yr)), scenario = sc))\n  catchMt  <- rbind(catchMt, cbind(catchMtSum(get(sc)$fleets, 'all', 'all', ac(2010:last.yr)), scenario = sc))\n  effortMt <- rbind(effortMt, cbind(effortMtSum(get(sc)$fleets, 'all',  ac(2010:last.yr)), scenario = sc))\n  \n  bioyr  <- subset(bio, year > 2009 & scenario == sc)\n  bioStd <- rbind(bioStd, subset(bioyr, indicator %in% c('ssb', 'rec', 'f', 'catch') & stock %in% c('HKE', 'MEG', 'MON', 'LDB', 'HOM') & scenario == sc))\n  \n  for(ind in  c('ssb', 'rec', 'f', 'catch')){\n    for(st in c('HKE', 'MEG', 'MON', 'LDB', 'HOM')){\n      xx <- subset(bioyr, indicator == ind & stock == st)$value\n      bioStd[bioStd$indicator == ind & bioStd$stock == st  & bioStd$scenario == sc,'value'] <- (xx - mean(xx))/sd(xx)\n    }}\n  \n}\n\n\nsave(bio, eco,catchFl,  catchMt, effortMt, bioStd, file = outputPath)\n\n",
    "created" : 1445505814482.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3410986048",
    "id" : "9791C8CA",
    "lastKnownWriteTime" : 1445506054,
    "path" : "~/Dropbox/IW Secretaria/Myfish_SG.R",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}